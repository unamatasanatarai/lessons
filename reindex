#!/usr/bin/env bash

set -euo pipefail

files=$(find journal -name "*.md" -type f)
mark_begin='### Table of Contents'
mark_end='> _n'\''joy!_'
toc=""

# shellcheck disable=2068
for file in ${files[@]}; do
  title=$(head -n1 "$file")
  toc+="1. [${title//# /}]($file)\n"
done

lb=$(grep -ne "$mark_begin" README.md | head -n 1 | awk -F: '{print $1}') || true
le=$(grep -ne "$mark_end" README.md | head -n 1 | awk -F: '{print $1}') || true

if [[ $lb != "" ]] && [[ $le != "" ]]; then
  sed "$lb,$le d" README.md > /tmp/readme.md
  cat /tmp/readme.md > README.md
fi

echo -e "$mark_begin\n\n$toc\n$mark_end" >> README.md

cat README.md
